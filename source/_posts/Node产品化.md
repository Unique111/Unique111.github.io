---
title: Node产品化
date: 2017-10-05
categories: ['node']
tags:
---
### 项目工程化
工程化：项目的组织能力。
在项目工程化过程中，最基本的几步是目录结构、构建工具、编码规范和代码审查等。

### 目录结构
目前，主要的两类项目为Web应用和模块应用。普通的模块应用遵循CommonJS的模块和包规范即可。对于Web应用，组织方式各种各样，但是只要遵循单一原则即可。常见的Web应用都是以MVC为主要框架的，其余部分在这个基础上进行扩展。

<!-- more -->

### 构建工具
有了源代码项目，只是完成了第一步。要想真正能用上源代码，还需要一定的操作，这些操作主要有合并静态文件、压缩文件大小、打包应用、编译模块等。将常用操作通过构建工具配置起来后，后续只要简单的命令就能完成大部分工作了。

- Makefile
- Grunt
Grunt的核心插件以grunt-contrib-开头，在NPM包管理平台上可以找到和查看。Grunt提供了3个模块分别用于运行时、初始化和命令行：grunt、grunt-init、grunt-cli。

### 编码规范
提升代码可读性、可维护性。JSLint，JSHint。

### 代码审查

### 部署流程
代码在完成开发、审查、合并之后，才会进入部署流程。尽管经过一系列严禁的人工审查和单元测试的质量保证，但也并不能直接上线到生产环境中直接运行，还需要在测试环境中测试之后才允许进入生产环境进行线上测试。

### 部署环境
test，stage，product

### 部署操作
开发环境中，直接在命令行中执行node file.js以启动应用。这对于开发中的应用而言，时常中断进程和频繁重启并无问题。但是对长时间执行的服务进程而言，这里存在两个问题：首先这会占据一个命令行窗口，其次随着窗口的退出会导致打开的进程一并退出。为了能让进程持续执行，我们可能会用到nohup和&以不挂断进程的方式执行：
``` javascript
nohup node app.js &
```

启动进程很容易，怎么停止进程和重启进程？
手工管理的方式显得繁琐，为此，我们需要一个脚本来实现应用的启动、停止和重启等操作。bash脚本是最精巧又擅长此类需求的。

脚本略。

### 性能

#### 动静分离
在普通的Web应用中，Node尽管也能通过中间件实现静态文件服务，但是Node处理静态文件的能力并不算突出。将图片、脚本、样式表和多媒体等静态文件都引导到专业的静态文件服务器上，让Node只处理动态请求即可。这个过程可以用Nginx或者专业的CDN来处理。

将动态请求和静态请求分离后，服务器可以专注在动态服务方面，专业的CDN会将静态文件与用户尽可能靠近，同时能够有更精确和高效的缓存机制。静态文件请求分离后，对静态请求使用不同的域名或多个域名还能消除掉不必要的Cookie传输和浏览器对下载线程数的限制。

#### 启用缓存
Redis，Memcached。

#### 多进程架构
通过多进程架构，不仅可以充分利用多核CPU，更是可以建立机制让Node进程更加健壮，以保障Web应用持续服务。
cluster，pm，forever，pm2等。

#### 读写分离
主要针对数据库。

### 日志
在健全的系统中，完善的日志记录最能够还原问题现场。

#### 访问日志
访问日志一般用来记录每个客户端对应用的访问。在Web应用中，主要记录HTTP请求中的关键数据。一般的Web服务器都实现了记录访问日志的功能，只需要简单的配置即可启用。在用Nginx或Apache进行反向代理时，可以利用这些已有的设施完成访问日志的记录。在Node开发的Web应用中，也可以自行实现访问日志的记录。

#### 异常日志
记录到文件中？createWriteStream？

在逐层次的异步API调用中，异常是该传递给调用方还是该立即通过日志记录，这是一个需要注意的问题。就通常的API编写而言，尽量不要隐藏错误，不要通过try/catch块将异常捕获，然后隐藏起来不向外部调用者暴露。这对于底层API的设计而言，尤为重要。事实上，日志通常是服务于业务的。建议异常尽量由最上层的调用者捕获记录，底层调用或中间层调用中出现的异常只要正常传递给上层的调用方即可。

#### 日志与数据库

#### 分割日志

### 监控报警
应用的监控主要有两类，一种是业务逻辑型的监控，一种是硬件型的监控。监控主要通过定时采样来进行记录。除此之外，还要对监控的信息设置上限，一旦出现大的波动，就需要发出警报提醒开发者。为了较好地供开发者使用，监控到的信息一般还要通过数据可视化的方式反映出来，以便更直观地查看。

#### 监控
监控的主要目的是为了将一些重要指标采样记录下来，一旦这些指标发生较大变化，可以配合报警系统将问题反馈到负责人那。监控的点可以很细致，也可以只选主要的指标。

- 日志监控
- QPS，PV，UV等
- 响应时间
- 响应时间可以在Nginx一类的反向代理商监控，也可以通过应用自行产生的访问日志来监控。
- 进程监控
- 磁盘监控
- 内存监控
- CPU占用监控
- CPU load监控
- I/O负载
- 网络监控
- 应用状态监控
- DNS监控

#### 报警的实现

- 邮件报警
- 短信或电话报警

#### 监控系统的稳定性

### 稳定性
- 多机器
多机器部署应用带来的好处是能利用更多的硬件资源，为更多的请求服务。同事能够在有故障时，继续服务用户请求，保证整体系统高可用性。但是一旦出现分布式，就需要考虑负载均衡、状态共享和数据一致性等问题。
- 多机房
- 容灾备份

### 异构共存







